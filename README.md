# History Pro - 强大的历史记录管理系统

一个高性能、稳定的历史记录管理网站，支持**多用户共享**和**高自由度上传**。

## ✨ 核心特性

### 🚀 高性能存储
- **本地存储**: IndexedDB 客户端存储，支持数GB数据
- **服务器同步**: Cloudflare Workers + KV 存储，支持多用户共享
- **双重模式**: 可切换本地/服务器模式

### 🔐 密钥管理系统
- **上传密钥**: 用于创建和更新记录（所有人可见）
- **删除密钥**: 用于删除记录（请谨慎保管）
- **安全存储**: 密钥存储在浏览器本地，不会上传

### 📝 高自由度上传
- **富文本编辑**: 支持格式化文本、链接、图片
- **附件上传**: 支持多文件上传
- **完整元数据**: 标题、URL、描述、分类、标签、时间

### 🌐 多用户共享
- **单用户上传，所有人可见**: 使用上传密钥发布的内容，所有访问者都能看到
- **实时同步**: 自动从服务器获取最新数据
- **批量操作**: 支持批量获取、分页、筛选

## 🛠️ 技术栈

- **Next.js 14** - React 框架，静态导出
- **TypeScript** - 类型安全
- **IndexedDB** - 高性能客户端数据库
- **Cloudflare Workers** - 服务器端 API
- **Cloudflare KV** - 分布式键值存储
- **Tailwind CSS** - 现代化样式
- **date-fns** - 日期处理
- **Lucide React** - 图标库

## 📦 安装

### 1. 安装依赖（工具下载到C盘）

```powershell
# 运行安装脚本
.\setup.ps1

# 或手动配置
npm config set cache "C:\npm-cache" --global
npm install
```

### 2. 配置 Cloudflare Workers

1. **创建 KV 命名空间**
   - 登录 Cloudflare Dashboard
   - 进入 Workers & Pages → KV
   - 创建新命名空间，记录 ID

2. **部署 Workers**
   ```bash
   cd workers
   npm install -g wrangler
   wrangler login
   # 编辑 wrangler.toml，填入 KV 命名空间 ID
   wrangler deploy
   ```

3. **设置环境变量**
   - 在 Cloudflare Dashboard 中设置：
     - `UPLOAD_KEY`: 上传密钥（建议使用强随机字符串）
     - `DELETE_KEY`: 删除密钥（建议使用强随机字符串）

### 3. 配置前端

创建 `.env.local` 文件：

```env
NEXT_PUBLIC_API_URL=https://your-worker.your-subdomain.workers.dev
```

### 4. 开发模式

```bash
npm run dev
```

访问 [http://localhost:3000](http://localhost:3000)

### 5. 构建静态文件

```bash
npm run build
```

构建后的文件在 `out/` 目录。

## ☁️ 部署

### Cloudflare Pages

1. 将代码推送到 GitHub/GitLab
2. 在 Cloudflare Dashboard 中连接到仓库
3. 构建命令: `npm run build`
4. 输出目录: `out`
5. 框架预设: `Next.js (Static HTML Export)`
6. 环境变量: 添加 `NEXT_PUBLIC_API_URL`

## 📝 使用说明

### 密钥管理

1. 访问 **设置** 页面 (`/settings`)
2. 输入从管理员获取的**上传密钥**和**删除密钥**
3. 点击"保存密钥"
4. 密钥会保存在浏览器本地

### 上传内容

#### 方式一：高自由度上传页面
1. 点击"高自由度上传"按钮
2. 填写完整信息（支持富文本、附件）
3. 点击"发布（所有人可见）"
4. 需要上传密钥

#### 方式二：快速添加
1. 点击"添加记录"按钮
2. 填写基本信息
3. 保存到本地或服务器

### 数据同步

- **自动同步**: 如果检测到服务器连接，会自动切换到服务器模式
- **手动同步**: 点击"同步"按钮从服务器获取最新数据
- **本地模式**: 如果未配置密钥或服务器不可用，使用本地存储

### 搜索和筛选

- **全文搜索**: 搜索标题、描述、URL、标签
- **分类筛选**: 按分类快速筛选
- **组合查询**: 支持搜索+筛选组合

## 🔧 架构说明

### 存储技术对比

| 特性 | IndexedDB (本地) | Cloudflare KV (服务器) |
|------|----------------|---------------------|
| 容量 | 数GB | 无限制（按使用量计费）|
| 速度 | 毫秒级 | 毫秒级（边缘网络）|
| 共享 | ❌ 仅本地 | ✅ 所有人可见 |
| 离线 | ✅ 支持 | ❌ 需要网络 |
| 成本 | 免费 | 按使用量（免费额度充足）|

### 多用户共享机制

1. **上传流程**:
   - 用户使用上传密钥调用 API
   - 数据存储到 Cloudflare KV
   - 所有访问者都能看到

2. **读取流程**:
   - 无需密钥，任何人都可以读取
   - 自动从服务器获取最新数据
   - 支持本地缓存加速

3. **删除流程**:
   - 需要删除密钥
   - 从服务器永久删除
   - 所有用户立即看到更新

## 🔒 安全说明

- ✅ 密钥存储在浏览器本地，不会上传到服务器
- ✅ API 密钥验证在服务器端进行
- ✅ 支持 HTTPS 加密传输
- ✅ 删除操作需要独立密钥，防止误删

## 📊 性能优化

- IndexedDB 使用索引加速查询
- Cloudflare Workers 边缘计算，全球加速
- 分页加载（默认100条）
- 本地缓存减少服务器请求

## 🐛 故障排除

### 无法连接到服务器

1. 检查 `NEXT_PUBLIC_API_URL` 环境变量
2. 确认 Workers 已部署
3. 检查浏览器控制台错误信息
4. 验证密钥是否正确

### 上传失败

1. 检查是否设置了上传密钥
2. 验证密钥是否正确
3. 查看浏览器控制台错误信息
4. 确认 Workers API 正常运行

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！
